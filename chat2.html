<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <link rel="shortcut icon"
        href="https://s3.fr-par.scw.cloud/typebot/public/typebots/mpx2cejn3v2yybieh00aexv2/favIcon?v=1689183570977"
        type="image/x-icon">
    <title>Chat Atendimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        #chat-container {
            height: 100vh;
            height: 100dvh;
            overflow-y: auto;
        }

        .chat-background {
            background-color: #f0f2f5;
            background-size: cover;
            background-position: center;
        }

        #chat-header, #footer {
            position: sticky;
            z-index: 10;
        }
        #chat-header { top: 0; }
        #footer { bottom: 0; }

        /* Estilos base para balões de mensagem */
        .message-out, .message-in {
            border-radius: 18px;
            padding: 8px 12px;
        }
        
        /* Caudas dos balões foram removidas para um visual mais limpo */
        .bubble-container::after {
            display: none !important;
        }

        .typing-ellipsis span {
            animation: blink 1.4s infinite both;
            display: inline-block;
            margin-left: 1px;
        }
        .typing-ellipsis span:nth-child(2) { animation-delay: .2s; }
        .typing-ellipsis span:nth-child(3) { animation-delay: .4s; }

        @keyframes blink {
            0%, 100% { opacity: .2; }
            20% { opacity: 1; }
        }

        /* Player de Áudio com novo design */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
        }
        .waveform-container {
            flex-grow: 1;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 2px;
            position: relative;
            overflow: hidden;
        }
        .waveform-bar-bg, .waveform-progress {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; gap: 2px;
        }
        .waveform-progress { z-index: 2; overflow: hidden; }
        .waveform-bar { width: 3px; border-radius: 2px; }
        .waveform-progress::after {
            content: ''; position: absolute; right: 0; top: 50%;
            transform: translate(50%, -50%); width: 14px; height: 14px;
            border-radius: 50%; z-index: 3;
        }
        .audio-player .play-button {
            width: 32px; height: 32px; background: none; border: none;
            cursor: pointer; flex-shrink: 0;
        }
        .audio-player .play-button i { font-size: 24px; color: #54656f; }
        
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0;
            overflow: hidden; max-width: 100%; background: #000;
            border-radius: 12px;
        }
        .video-container iframe, .video-container video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }

        .message-enter { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .image-loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        .loader {
            border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
        }
        
        .imgs0cs { max-width: 300px; border-radius: 12px; }
        .pb-20 { padding-bottom: 140px !important; }

        /* NOVO ESTILO PARA BOTÕES DE ESCOLHA */
        .choice-button.btnblockcss {
            border-radius: 12px; padding: 10px 16px; margin: 4px 0 !important;
            cursor: pointer; transition: all 0.2s ease; font-weight: 500;
        }
        .choice-button.btnblockcss:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .vid-css { border-radius: 12px; min-width: 19.5rem; overflow: hidden; }
        .max-w-xs { max-width: 22rem !important; }
    </style>
</head>

<body class="bg-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[9999] flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-white font-semibold text-lg">Carregando chat...</p>
        </div>
    </div>

    <div id="chat-container" class="w-full max-w-lg mx-auto flex flex-col chat-background shadow-2xl">
        <header id="chat-header" class="p-3 flex items-center shadow-sm z-10 flex-shrink-0 border-b">
            <button class="mr-4"><i class="fa-solid fa-arrow-left"></i></button>
            <img id="bot-avatar" src="https://placehold.co/40x40/3498DB/FFFFFF?text=B" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
            <div class="flex-grow">
                <h2 id="bot-name" class="font-semibold text-lg">Carregando...</h2>
                <p id="contact-status" class="text-sm h-4 font-medium"></p>
            </div>
            <div class="flex items-center space-x-5 text-xl px-2">
                <button title="Ligar"><i class="fa-solid fa-phone"></i></button>
                <button title="Chamada de video"><i class="fa-solid fa-video"></i></button>
                <button title="Mais opções"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
        </header>

        <main id="chat-messages" class="flex-grow p-4 pb-20">
            <div class="space-y-2"></div>
        </main>

        <footer id="footer" class="p-2 flex items-center space-x-2 border-t flex-shrink-0">
            <div class="flex-grow flex items-center bg-white rounded-full p-1 shadow-sm border">
                <input id="message-input" type="text" placeholder="Digite uma mensagem..." class="flex-grow bg-transparent focus:outline-none mx-3 text-gray-800">
            </div>
            <button id="action-button" class="text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all duration-200 transform hover:scale-110 flex-shrink-0">
                <i id="send-icon" class="fa-solid fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <div id="image-viewer-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
        <button id="close-image-viewer-btn" class="absolute top-4 right-5 text-white text-4xl font-light">×</button>
        <img id="full-image-view" src="" class="max-w-full max-h-full object-contain rounded-lg" alt="Visualização ampliada">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCOAUpRQbLmLO4tzzK6xVeGxGO7eDF4NVQ", authDomain: "cmdadteste-hoje.firebaseapp.com", databaseURL: "https://cmdadteste-hoje-default-rtdb.firebaseio.com", projectId: "cmdadteste-hoje", storageBucket: "cmdadteste-hoje.appspot.com", messagingSenderId: "831622336654", appId: "1:831622336654:web:a393593df3eb51702cf9df" };
        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getDatabase(firebaseApp);
            const auth = getAuth(firebaseApp);
            onAuthStateChanged(auth, user => {
                if (!user) {
                    signInAnonymously(auth).catch(error => {
                        console.error("Erro no login anônimo:", error);
                        addMessageBubble("Erro de autenticação.", false);
                    });
                } else {
                    console.log("Usuário autenticado:", user.uid);
                    startFlow();
                }
            });
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            addMessageBubble("Erro de conexão com o servidor do bot.", false);
        }

        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const actionButton = document.getElementById('action-button');
        const contactStatus = document.getElementById('contact-status');
        const footer = document.getElementById('footer');
        const botNameHeader = document.getElementById('bot-name');
        const botAvatarHeader = document.getElementById('bot-avatar');
        const loadingOverlay = document.getElementById('loading-overlay');
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const fullImageView = document.getElementById('full-image-view');
        const closeImageViewerBtn = document.getElementById('close-image-viewer-btn');

        let flowData = { nodes: [], connections: [], settings: {} };
        let flowVariables = {};
        let currentNodeId = null;
        let isWaitingForInput = false;
        let flowId, sessionRef;

        const scrollToBottom = () => {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        };

        const replaceVariables = (text) => {
            if (!text || typeof text !== 'string') return '';
            return text.replace(/{{(.*?)}}/g, (match, varName) => {
                const trimmedVar = varName.trim();
                const value = flowVariables[trimmedVar];
                if (typeof value === 'object' && value !== null) {
                    return JSON.stringify(value, null, 2);
                }
                return value !== undefined ? value : match;
            });
        };

        function getValueFromPath(obj, path) {
            if (!path) return undefined;
            if (path === 'datajsonvalue') return obj;
            return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        // FUNÇÃO DE TEMA CORRIGIDA E ATUALIZADA COM O NOVO DESIGN
        function applyTheme(settings) {
            const header = document.getElementById('chat-header');
            const chatBackground = document.querySelector('.chat-background');
            const footerEl = document.getElementById('footer');
            const footerInputContainer = footerEl.querySelector('div');
            const actionButtonEl = document.getElementById('action-button');

            const theme = settings.chatTheme || 'light'; // 'light' como novo padrão
            const customBackground = settings.chatBackground;
            const defaultBackgrounds = {
                dark: '#1C2833',
                light: '#F4F6F6',
                // Fallbacks para temas antigos
                'dark-custom': '#1C2833',
                'white': '#F4F6F6'
            };
            const backgroundUrl = customBackground || defaultBackgrounds[theme];

            // CORREÇÃO: Verifica se backgroundUrl é uma string antes de usar startsWith
            if (backgroundUrl && typeof backgroundUrl === 'string' && backgroundUrl.startsWith('http')) {
                chatBackground.style.backgroundImage = `url('${backgroundUrl}')`;
                chatBackground.style.backgroundColor = '';
            } else {
                chatBackground.style.backgroundColor = backgroundUrl || '#F4F6F6';
                chatBackground.style.backgroundImage = 'none';
            }

            let themeStyles = {};

            if (theme.startsWith('dark')) { // Novo tema escuro elegante
                themeStyles = {
                    headerBg: '#17202A', headerText: '#EAF2F8', statusText: '#AAB7B8',
                    messageInBg: '#2C3E50', messageInText: '#EAF2F8',
                    messageOutBg: '#2980B9', messageOutText: '#FFFFFF',
                    footerBg: '#17202A', footerBorder: '#2C3E50',
                    footerInputBg: '#2C3E50', footerInputText: '#EAF2F8', footerPlaceholder: '#AAB7B8',
                    actionButtonBg: '#3498DB', actionButtonHover: '#5DADE2',
                    bodyBg: '#1C2833',
                    choiceBtnBg: '#2C3E50', choiceBtnText: '#EAF2F8', choiceBtnBorder: '#3498DB',
                    choiceBtnHoverBg: '#3498DB', choiceBtnHoverText: '#FFFFFF',
                    audioProgress: '#3498DB', audioBg: '#566573'
                };
            } else { // Novo tema claro elegante
                themeStyles = {
                    headerBg: '#FFFFFF', headerText: '#2C3E50', statusText: '#2ECC71',
                    messageInBg: '#FFFFFF', messageInText: '#2C3E50',
                    messageOutBg: '#3498DB', messageOutText: '#FFFFFF',
                    footerBg: '#F4F6F6', footerBorder: '#D5D8DC',
                    footerInputBg: '#FFFFFF', footerInputText: '#2C3E50', footerPlaceholder: '#95A5A6',
                    actionButtonBg: '#3498DB', actionButtonHover: '#2980B9',
                    bodyBg: '#E5E7EB',
                    choiceBtnBg: '#FFFFFF', choiceBtnText: '#3498DB', choiceBtnBorder: '#3498DB',
                    choiceBtnHoverBg: '#3498DB', choiceBtnHoverText: '#FFFFFF',
                    audioProgress: '#3498DB', audioBg: '#BDC3C7'
                };
            }
            
            document.body.style.backgroundColor = themeStyles.bodyBg;
            header.style.backgroundColor = themeStyles.headerBg;
            header.style.borderColor = themeStyles.footerBorder;
            header.querySelectorAll('h2, button, i').forEach(el => el.style.color = themeStyles.headerText);
            contactStatus.style.color = themeStyles.statusText;
            
            footerEl.style.backgroundColor = themeStyles.footerBg;
            footerEl.style.borderColor = themeStyles.footerBorder;
            footerInputContainer.style.backgroundColor = themeStyles.footerInputBg;
            footerInputContainer.style.borderColor = themeStyles.footerBorder;
            messageInput.style.color = themeStyles.footerInputText;
            actionButtonEl.style.backgroundColor = themeStyles.actionButtonBg;

            let dynamicStyleContent = `
                .message-in { background-color: ${themeStyles.messageInBg}; color: ${themeStyles.messageInText}; }
                .message-in p, .message-in .time-display { color: ${themeStyles.messageInText}; }
                .message-out { background-color: ${themeStyles.messageOutBg}; color: ${themeStyles.messageOutText}; }
                .message-out p, .message-out .time-display { color: ${themeStyles.messageOutText}; }
                #footer input::placeholder { color: ${themeStyles.footerPlaceholder}; }
                #action-button:hover { background-color: ${themeStyles.actionButtonHover} !important; }
                .choice-button.btnblockcss { 
                    background-color: ${themeStyles.choiceBtnBg} !important; 
                    color: ${themeStyles.choiceBtnText} !important;
                    border: 1px solid ${themeStyles.choiceBtnBorder};
                }
                .choice-button.btnblockcss:hover {
                    background-color: ${themeStyles.choiceBtnHoverBg} !important; 
                    color: ${themeStyles.choiceBtnHoverText} !important;
                }
                .waveform-bar { background-color: ${themeStyles.audioBg}; }
                .waveform-progress .waveform-bar { background-color: ${themeStyles.audioProgress}; }
                .waveform-progress::after { background-color: ${themeStyles.audioProgress}; }
            `;

            const styleElement = document.getElementById('dynamic-theme-styles') || document.createElement('style');
            styleElement.id = 'dynamic-theme-styles';
            styleElement.textContent = dynamicStyleContent;

            if (!document.getElementById('dynamic-theme-styles')) {
                document.head.appendChild(styleElement);
            }
        }

        function findNextNode(nodeId, fromPort = null) {
            const parentGroup = flowData.nodes.find(p => p.type === 'group' && p.data?.children?.includes(nodeId));
            if (parentGroup) {
                const children = parentGroup.data.children;
                const currentIndex = children.indexOf(nodeId);
                if (currentIndex < children.length - 1) {
                    return flowData.nodes.find(n => n.id === children[currentIndex + 1]);
                } else {
                    const connection = flowData.connections.find(c => c.from === parentGroup.id);
                    return connection ? flowData.nodes.find(n => n.id === connection.to) : null;
                }
            } else {
                const connection = flowData.connections.find(c => c.from === nodeId && (c.fromPort || null) === fromPort);
                return connection ? flowData.nodes.find(n => n.id === connection.to) : null;
            }
        }

        function endFlow() {
            console.log("Fim do fluxo.");
            footer.classList.add('hidden');
            if (sessionRef) {
                update(sessionRef, { status: 'completed', endTime: new Date().toISOString() });
            }
        }

        async function startFlow() {
            if (!db) return;
            contactStatus.textContent = 'conectando...';

            const pathSegments = window.location.pathname.split('/').filter(Boolean);
            flowId = pathSegments[pathSegments.length - 1] || 'default_flow';

            const sessionId = `session_${Date.now()}`;
            sessionRef = ref(db, `analytics/${flowId}/${sessionId}`);
            set(sessionRef, { startTime: new Date().toISOString(), status: 'initiated', variables: {} });

            const flowRef = ref(db, `published_bots/${flowId}`);
            try {
                const snapshot = await get(flowRef);
                if (snapshot.exists()) {
                    flowData = snapshot.val();
                    flowData.nodes = flowData.nodes || [];
                    flowData.connections = flowData.connections || [];
                    flowData.settings = flowData.settings || {};

                    applyTheme(flowData.settings);

                    botNameHeader.textContent = flowData.settings.botName || 'Assistente Virtual';
                    document.title = flowData.settings.botName || 'Assistente Virtual';
                    botAvatarHeader.src = flowData.settings.botAvatar || 'https://placehold.co/40x40/3498DB/FFFFFF?text=A';
                    contactStatus.textContent = 'online';

                    flowData.nodes.forEach(node => {
                        if (node.type === 'buttons' && node.data.buttons && node.data.buttons.length > 0 && typeof node.data.buttons[0] === 'string') {
                            node.data.buttons = node.data.buttons.map(buttonText => ({ label: buttonText, target: null }));
                        }
                    });

                    const startNode = flowData.nodes.find(n => n.type === 'start');
                    if (startNode) {
                        executeNextNode(startNode.id);
                    } else {
                        addMessageBubble("Erro: Bloco 'Início' não encontrado no fluxo.", false);
                    }
                } else {
                    addMessageBubble(`Bot não encontrado. Verifique se o ID "${flowId}" está correto.`, false);
                    botNameHeader.textContent = "Erro";
                    contactStatus.textContent = "offline";
                }
            } catch (error) {
                console.error("Erro ao carregar o fluxo:", error);
                addMessageBubble("Não foi possível carregar o fluxo de atendimento.", false);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function executeNextNode(fromNodeId, options = {}) {
            const { isButtonChoice = false, targetNodeId = null, fromPort = null } = options;
            let nodeToExecute;
            if (isButtonChoice) {
                nodeToExecute = targetNodeId ? flowData.nodes.find(n => n.id === targetNodeId) : null;
            } else {
                nodeToExecute = findNextNode(fromNodeId, fromPort);
            }
            if (nodeToExecute) {
                processNode(nodeToExecute);
            } else {
                endFlow();
            }
        }

        function evaluateCondition(variableValue, operator, conditionValue) {
            const numVar = parseFloat(variableValue);
            const numCond = parseFloat(conditionValue);
            switch (operator) {
                case '==': return variableValue == conditionValue;
                case '!=': return variableValue != conditionValue;
                case 'contains': return String(variableValue).includes(conditionValue);
                case '!contains': return !String(variableValue).includes(conditionValue);
                case '>': return !isNaN(numVar) && !isNaN(numCond) && numVar > numCond;
                case '<': return !isNaN(numVar) && !isNaN(numCond) && numVar < numCond;
                default: return false;
            }
        }

        async function processNode(node) {
            if (!node) return;
            currentNodeId = node.id;
            const processedText = replaceVariables(node.data?.text);

            if (node.type === 'delay') {
                const delay = (node.data.delay || 0) * 1000;
                if (delay > 0) {
                    const nextNodeAfterDelay = findNextNode(node.id);
                    const isNextNodeAudio = nextNodeAfterDelay && nextNodeAfterDelay.type === 'audio';
                    await new Promise(resolve => setTimeout(resolve, 500));
                    contactStatus.innerHTML = `${isNextNodeAudio ? 'gravando áudio' : 'digitando'}<span class="typing-ellipsis"><span>.</span><span>.</span><span>.</span></span>`;
                    await new Promise(resolve => setTimeout(resolve, Math.max(0, delay - 500)));
                    contactStatus.textContent = 'online';
                }
                executeNextNode(node.id);
                return;
            }

            switch (node.type) {
                case 'message': case 'image': case 'audio': case 'video':
                    addMessageBubble(processedText, false, { ...node.data, type: node.type });
                    executeNextNode(node.id);
                    break;
                case 'redirect':
                    setTimeout(() => {
                        const url = replaceVariables(node.data.url);
                        if (node.data.openInNewTab) window.open(url, '_blank');
                        else window.location.href = url;
                    }, 1000);
                    endFlow();
                    break;
                case 'buttons':
                    addMessageBubble(processedText, false, { buttons: node.data.buttons || [], type: 'buttons' });
                    isWaitingForInput = false;
                    footer.classList.add('hidden');
                    break;
                case 'condition':
                    const variableName = node.data.variable;
                    const operator = node.data.operator;
                    const conditionValue = replaceVariables(node.data.value);
                    const variableValue = flowVariables[variableName] || '';
                    const result = evaluateCondition(String(variableValue), operator, conditionValue);
                    executeNextNode(node.id, { fromPort: result ? 'if' : 'else' });
                    break;
                case 'input':
                    addMessageBubble(processedText, false);
                    isWaitingForInput = true;
                    footer.classList.remove('hidden');
                    messageInput.focus();
                    break;
                case 'group':
                    const firstChildId = node.data.children?.[0];
                    if (firstChildId) processNode(flowData.nodes.find(n => n.id === firstChildId));
                    else executeNextNode(node.id);
                    break;
                case 'embed':
                    addMessageBubble('', false, { type: 'embed', embedData: { code: node.data.embedCode, height: node.data.height } });
                    executeNextNode(node.id);
                    break;
                case 'http-request':
                    contactStatus.textContent = 'processando...';
                    try {
                        const proxyFunctionUrl = 'https://fluxius-chat-proxy-v1.netlify.app/.netlify/functions/proxy';
                        const originalRequestData = {
                            targetUrl: replaceVariables(node.data.url),
                            method: node.data.method || 'GET', headers: {}, body: null
                        };
                        if (node.data.headers) {
                            node.data.headers.forEach(h => { if (h.key) originalRequestData.headers[h.key] = replaceVariables(h.value); });
                        }
                        if (['POST', 'PUT'].includes(originalRequestData.method) && node.data.body) {
                            try { originalRequestData.body = JSON.parse(replaceVariables(node.data.body)); }
                            catch (e) { originalRequestData.body = replaceVariables(node.data.body); }
                        }
                        const response = await fetch(proxyFunctionUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(originalRequestData) });
                        if (!response.ok) throw new Error(`Erro no proxy: ${(await response.json()).error || response.statusText}`);
                        const responseData = await response.json();
                        if (node.data.responseMappings) {
                            node.data.responseMappings.forEach(m => {
                                if (m.path && m.variable) {
                                    const value = getValueFromPath(responseData, m.path);
                                    if (value !== undefined) updateSessionVariable(m.variable, value);
                                }
                            });
                        }
                    } catch (error) { console.error('Erro na requisição HTTP:', error.message); }
                    finally {
                        contactStatus.textContent = 'online';
                        executeNextNode(node.id);
                    }
                    break;
            }
        }

        function updateSessionVariable(key, value) {
            flowVariables[key] = value;
            if (sessionRef) {
                set(ref(db, `analytics/${flowId}/${sessionRef.key}/variables/${key}`), value);
            }
        }

        function handleButtonChoice(label, targetNodeId, buttonsContainer) {
            addMessageBubble(label, true);
            if (buttonsContainer) buttonsContainer.parentElement.remove();
            executeNextNode(currentNodeId, { isButtonChoice: true, targetNodeId: targetNodeId });
        }
        
        function validateInput(text, type) {
            if (!type || type === 'text') return true;
            switch (type) {
                case 'email': return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(text);
                case 'number': return !isNaN(parseFloat(text)) && isFinite(text);
                case 'phone': return /^\d{10,11}$/.test(text.replace(/\D/g, ''));
                default: return true;
            }
        }

        function handleUserInput(text) {
            addMessageBubble(text, true);
            if (!isWaitingForInput) return;
            const currentNode = flowData.nodes.find(n => n.id === currentNodeId);
            if (currentNode?.type === 'input') {
                const inputType = currentNode.data.inputType || 'text';
                if (!validateInput(text, inputType)) {
                    let errorMessages = { email: "Formato de e-mail inválido.", number: "Digite apenas números.", phone: "Formato de celular inválido." };
                    setTimeout(() => addMessageBubble(errorMessages[inputType] || "Formato inválido.", false), 500);
                    return; 
                }
                if (currentNode.data.variableName) {
                    updateSessionVariable(currentNode.data.variableName, text);
                }
            }
            isWaitingForInput = false;
            footer.classList.add('hidden');
            executeNextNode(currentNodeId);
        }

        function openImageViewer(src) {
            fullImageView.src = src;
            imageViewerModal.classList.remove('hidden');
            imageViewerModal.classList.add('flex');
        }

        function closeImageViewer() {
            imageViewerModal.classList.add('hidden');
            imageViewerModal.classList.remove('flex');
            fullImageView.src = '';
        }

        actionButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                handleUserInput(text);
                messageInput.value = '';
            }
        });
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') actionButton.click(); });
        messageInput.addEventListener('focus', () => { setTimeout(scrollToBottom, 300); });
        closeImageViewerBtn.addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) closeImageViewer(); });

        function createEmbedElement(embedData) {
            const container = document.createElement('div');
            container.className = 'w-full rounded-xl overflow-hidden';
            container.style.height = `${embedData.height || 400}px`;
            const code = (embedData.code || '').trim();
            if (/<iframe/i.test(code)) {
                container.innerHTML = code;
                const iframe = container.querySelector('iframe');
                if (iframe) {
                    iframe.style.width = '100%'; iframe.style.height = '100%';
                    iframe.setAttribute('frameborder', '0'); iframe.style.borderRadius = '12px';
                }
            } else if (/^https?:\/\//i.test(code)) {
                container.innerHTML = `<iframe src="${code}" style="width:100%; height:100%; border-radius:12px;" frameborder="0" allowfullscreen></iframe>`;
            } else {
                container.innerHTML = '<p class="text-xs text-red-500 p-2">Código de incorporação inválido.</p>';
                container.style.height = 'auto';
            }
            return container;
        }

        // FUNÇÃO addMessageBubble RESTAURADA E INTEGRADA COM NOVO DESIGN
        function addMessageBubble(message, isOutgoing, options = {}) {
            const { url = '', buttons = [], type = 'message', embedData = null } = options;
            const imageUrl = type === 'image' ? url : '';
            const audioUrl = type === 'audio' ? url : '';
            const videoUrl = type === 'video' ? url : '';

            const messageList = chatMessages.querySelector('.space-y-2');
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-enter');

            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'bubble-container';

            const bubble = document.createElement('div');
            bubble.className = `p-2 rounded-xl shadow-sm max-w-xs lg:max-w-md ${isOutgoing ? 'message-out' : 'message-in'}`;
            
            if (type === 'embed' && embedData?.code) {
                bubble.appendChild(createEmbedElement(embedData));
                bubble.classList.add('p-1', 'overflow-hidden', 'bg-transparent', 'shadow-none');
            } else if (audioUrl) {
                const audioPlayer = document.createElement('div');
                audioPlayer.className = 'audio-player w-full items-center p-1';
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.innerHTML = `<i class="fa-solid fa-play"></i>`;
                playButton.disabled = true;

                const waveformContainer = document.createElement('div');
                waveformContainer.className = 'waveform-container';
                const waveformBg = document.createElement('div');
                waveformBg.className = 'waveform-bar-bg';
                const progress = document.createElement('div');
                progress.className = 'waveform-progress';
                
                for (let i = 0; i < 40; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'waveform-bar';
                    bar.style.height = `${Math.floor(Math.random() * 95) + 5}%`;
                    waveformBg.appendChild(bar);
                }
                progress.innerHTML = waveformBg.innerHTML;
                waveformContainer.append(waveformBg, progress);
                audioPlayer.append(playButton, waveformContainer);

                const metaContainer = document.createElement('div');
                metaContainer.className = 'flex justify-between items-center px-1 mt-1';
                const timeDisplay = document.createElement('span');
                timeDisplay.className = 'text-xs';
                timeDisplay.textContent = '0:00';
                const messageTime = document.createElement('span');
                messageTime.className = 'text-xs';
                messageTime.textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                metaContainer.append(timeDisplay, messageTime);
                bubble.append(audioPlayer, metaContainer);

                const audioElement = new Audio(replaceVariables(audioUrl));
                const formatTime = (time) => isFinite(time) ? `${Math.floor(time / 60)}:${String(Math.floor(time % 60)).padStart(2, '0')}` : "0:00";
                
                audioElement.addEventListener('loadedmetadata', () => {
                    playButton.disabled = false;
                    timeDisplay.textContent = formatTime(audioElement.duration);
                });
                audioElement.addEventListener('timeupdate', () => {
                    progress.style.width = `${(audioElement.currentTime / audioElement.duration) * 100}%`;
                    timeDisplay.textContent = formatTime(audioElement.currentTime);
                });
                playButton.onclick = () => { audioElement.paused ? audioElement.play() : audioElement.pause(); };
                audioElement.addEventListener('play', () => playButton.innerHTML = `<i class="fa-solid fa-pause"></i>`);
                audioElement.addEventListener('pause', () => playButton.innerHTML = `<i class="fa-solid fa-play"></i>`);
                audioElement.onended = () => {
                    progress.style.width = `0%`;
                    timeDisplay.textContent = formatTime(audioElement.duration);
                };

            } else if (imageUrl) {
                const finalImageUrl = replaceVariables(imageUrl);
                const imageContainer = document.createElement('div');
                imageContainer.className = 'relative w-full min-h-[100px] bg-gray-200 rounded-xl flex items-center justify-center cursor-pointer overflow-hidden';
                imageContainer.addEventListener('click', () => openImageViewer(finalImageUrl));
                const loader = document.createElement('div');
                loader.className = 'image-loader';
                imageContainer.appendChild(loader);
                const img = document.createElement('img');
                img.src = finalImageUrl;
                img.className = 'max-w-full h-auto hidden imgs0cs';
                img.onload = () => {
                    loader.style.display = 'none';
                    img.style.display = 'block';
                    imageContainer.style.minHeight = '0';
                    scrollToBottom();
                };
                imageContainer.appendChild(img);
                bubble.appendChild(imageContainer);
                bubble.classList.add('p-1');
            } else if (videoUrl) {
                const finalVideoUrl = replaceVariables(videoUrl);
                const videoWrapper = document.createElement('div');
                videoWrapper.className = 'video-container my-1';
                if (finalVideoUrl.includes('youtube.com') || finalVideoUrl.includes('youtu.be')) {
                    const videoId = finalVideoUrl.split('v=')[1]?.split('&')[0] || finalVideoUrl.split('/').pop();
                    videoWrapper.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                } else {
                    videoWrapper.innerHTML = `<video controls src="${finalVideoUrl}"></video>`;
                }
                bubble.appendChild(videoWrapper);
                bubble.classList.add('p-1');
            }

            if (message) {
                const textElement = document.createElement('p');
                textElement.className = 'break-words px-2';
                if (imageUrl || audioUrl || videoUrl || embedData?.code) textElement.classList.add('mt-2');
                textElement.innerHTML = message.replace(/\n/g, '<br>');
                bubble.appendChild(textElement);
            }

            if (type !== 'audio') {
                const metaContainer = document.createElement('div');
                metaContainer.className = 'flex items-center justify-end space-x-1 px-2 pt-1';
                const timeElement = document.createElement('p');
                timeElement.className = 'text-xs opacity-70';
                timeElement.textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                metaContainer.appendChild(timeElement);
                if (isOutgoing) {
                    metaContainer.innerHTML += `<span class="ml-1 opacity-70"><i class="fa-solid fa-check-double text-current"></i></span>`;
                }
                bubble.appendChild(metaContainer);
            }

            bubbleContainer.appendChild(bubble);
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex w-full ${isOutgoing ? 'justify-end' : 'justify-start'}`;
            messageContainer.appendChild(bubbleContainer);
            messageWrapper.appendChild(messageContainer);
            messageList.appendChild(messageWrapper);

            if (type === 'buttons' && buttons.length > 0) {
                const buttonsWrapper = document.createElement('div');
                buttonsWrapper.className = 'w-full flex justify-end mt-2';
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex flex-col items-end gap-2';
                buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.className = 'choice-button btnblockcss';
                    const processedLabel = replaceVariables(buttonData.label);
                    button.textContent = processedLabel;
                    button.onclick = () => handleButtonChoice(processedLabel, buttonData.target, buttonsContainer);
                    buttonsContainer.appendChild(button);
                });
                buttonsWrapper.appendChild(buttonsContainer);
                messageList.appendChild(buttonsWrapper);
            }
            scrollToBottom();
        }
    </script>
</body>

</html>
